name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean
      is-release-please-pr:
        description: "Whether this is a release-please PR (enables auto-commit of codegen changes)"
        required: false
        type: boolean
        default: false
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN:
        required: true
      TURBOREPO_REMOTE_CACHING_TEAM:
        required: true
      DOCKER_USERNAME:
        required: true
      DOCKER_PASSWORD:
        required: true
      # Required for release-please PRs to push codegen changes with a token that triggers workflow re-runs
      # (pushes made with GITHUB_TOKEN do not trigger workflows by design)
      # see https://stackoverflow.com/a/67551255
      ARCHESTRA_RELEASER_GITHUB_APP_ID:
        required: false
      ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY:
        required: false

jobs:
  paths-filter:
    name: Detect changed paths
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      mcp-server-base-image: ${{ steps.filter.outputs.mcp-server-base-image }}
      platform-code: ${{ steps.filter.outputs.platform-code }}
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Filter paths
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            mcp-server-base-image:
              - 'platform/mcp_server_docker_image/**'
              - '.github/workflows/build-base-mcp-server-docker-image.yml'
            platform-code:
              - 'platform/**'
              - '.github/**'
              - '!platform/**/*.md'
              - '!docs/**'

  # Build Docker image in parallel with e2e-preflight job
  # This saves ~2-3 minutes by not blocking on Kind cluster creation
  # Skip for docs-only changes to save CI time
  build-platform-image:
    name: Build Platform Image
    runs-on: blacksmith-8vcpu-ubuntu-2404
    needs: [paths-filter]
    if: ${{ inputs.should-skip-running-and-always-succeed != true && needs.paths-filter.outputs.platform-code == 'true' }}
    permissions:
      contents: read
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Build Docker image
        id: build
        uses: ./.github/actions/build-platform-docker-image
        with:
          context: ./platform
          load: "true"
          tags: archestra/platform:ci-test
          turbo-team: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
          turbo-token: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}

      - name: Save Docker image
        run: |
          docker save archestra/platform:ci-test -o /tmp/platform-image.tar
          echo "image-tag=archestra/platform:ci-test" >> $GITHUB_OUTPUT

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: platform-docker-image
          path: /tmp/platform-image.tar
          retention-days: 1
          compression-level: 0 # Already compressed

  # Run preflight checks (codegen, migrations) in parallel with Docker build
  # These checks don't need the Docker image or Kind cluster
  # Skip for docs-only changes to save CI time
  e2e-preflight:
    name: E2E Preflight Checks
    runs-on: blacksmith-8vcpu-ubuntu-2404
    needs: [paths-filter]
    if: ${{ inputs.should-skip-running-and-always-succeed != true && needs.paths-filter.outputs.platform-code == 'true' }}
    permissions:
      contents: write
    outputs:
      should-continue: ${{ steps.codegen-check.outputs.should-continue }}
    steps:
      - name: Generate token for release-please PR
        if: ${{ inputs.is-release-please-pr == true }}
        id: generate-token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        with:
          app-id: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_ID }}
          private-key: ${{ secrets.ARCHESTRA_RELEASER_GITHUB_APP_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: ${{ inputs.is-release-please-pr }}
          ref: ${{ inputs.is-release-please-pr && github.head_ref || '' }}
          token: ${{ steps.generate-token.outputs.token || github.token }}

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Check drizzle-kit migrations consistency
        working-directory: ./platform/backend
        run: pnpm drizzle-kit check

      - name: Check for codegen'd changes
        id: codegen-check
        working-directory: ./platform
        env:
          IS_RELEASE_PLEASE_PR: ${{ inputs.is-release-please-pr }}
        run: |
          pnpm codegen
          pnpm lint:fix

          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            if [ "$IS_RELEASE_PLEASE_PR" == "true" ]; then
              echo "ðŸ“¦ Release-please PR with codegen changes detected. Auto-committing..."
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git -C "$GITHUB_WORKSPACE" add docs/ platform/
              git commit -m "chore: update docs/openapi.json version for release"
              git push
              echo "âœ… Changes committed. Workflow will be re-triggered."
              echo "should-continue=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "::error::Generated code is not up to date. Please run 'pnpm codegen && pnpm lint:fix' locally and commit the changes."
              exit 1
            fi
          else
            echo "Generated code is up to date"
            echo "should-continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify no pending database migrations
        working-directory: ./platform
        run: |
          set +e
          echo "Running pnpm db:generate -- awaiting up to 15 seconds for a potential drizzle-kit generate interactive prompt"

          if timeout 15s pnpm db:generate > /tmp/db_generate_output.txt 2>&1; then
            output=$(cat /tmp/db_generate_output.txt)
            echo "Output from pnpm db:generate:"
            echo "$output"

            if echo "$output" | grep -q "â¯\|Is.*table created or renamed"; then
              echo "âŒ Interactive prompt detected - there are pending database migrations that need to be committed"
              exit 1
            fi
          else
            exit_code=$?
            output=$(cat /tmp/db_generate_output.txt 2>/dev/null || echo "No output captured")
            echo "Output from pnpm db:generate (before timeout/failure):"
            echo "$output"

            if [ $exit_code -eq 124 ]; then
              echo "âŒ Command timed out - likely waiting for interactive input about pending database migrations"
            else
              echo "âŒ pnpm db:generate failed with exit code $exit_code"
            fi
            exit 1
          fi

          set -e

          if ! git diff --exit-code || ! git diff --cached --exit-code; then
            echo "::error::Database schema has changed but migrations are missing."
            git diff --name-only
            git diff --cached --name-only
            exit 1
          else
            echo "âœ… No new migration files were generated - schema is in sync with migrations"
          fi

  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: blacksmith-8vcpu-ubuntu-2404
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform
    env:
      TURBO_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBO_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

  platform-e2e-tests:
    name: Platform e2e Tests
    runs-on: blacksmith-16vcpu-ubuntu-2404
    # Wait for Docker image build and preflight checks to complete
    # These run in parallel, so we wait for both
    needs: [paths-filter, build-platform-image, e2e-preflight]
    # Skip if:
    # - should-skip is true
    # - docs-only changes (platform-code == false)
    # - preflight determined we should stop (e.g., release-please auto-commit)
    if: |
      inputs.should-skip-running-and-always-succeed != true &&
      needs.paths-filter.outputs.platform-code == 'true' &&
      needs.e2e-preflight.outputs.should-continue == 'true'
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Download Docker image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: platform-docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/platform-image.tar

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      # Setup Kind cluster and deploy (image already built)
      - name: Setup Archestra Platform
        uses: ./.github/actions/setup-archestra-platform
        with:
          kind-config-path: .github/kind.yaml
          kind-cluster-name: archestra-ci-cluster
          helm-values-path: .github/values-ci.yaml
          deploy-e2e-dependencies: "true"
          build-platform-image: "false"
          platform-image-tag: archestra/platform:ci-test
          platform-context: ./platform

      # Resolve Playwright version for the container used to run e2e tests
      - name: Resolve Playwright version
        run: |
          VERSION=$(cat platform/e2e-tests/package.json | jq -r '.devDependencies["@playwright/test"]' | sed 's/^[\^~]//')
          echo "Resolved Playwright version: $VERSION"
          echo "PLAYWRIGHT_VERSION=$VERSION" >> $GITHUB_ENV

      # Run E2E tests inside the official Playwright container
      # This eliminates the need for manual Playwright browser installation and caching
      # See https://github.com/microsoft/playwright/issues/7249#issuecomment-3345742301
      - name: Run E2E tests
        id: e2e
        working-directory: ./platform
        run: |
          set -o pipefail
          docker run --rm \
            --network host \
            --ipc=host \
            -v "$GITHUB_WORKSPACE:/work" \
            -w /work/platform \
            -e CI=true \
            -e PLAYWRIGHT_BROWSERS_PATH=/ms-playwright \
            "mcr.microsoft.com/playwright:v${PLAYWRIGHT_VERSION}-noble" \
            /bin/bash -c "corepack enable && corepack prepare pnpm@10.24.0 --activate && pnpm test:e2e" \
            2>&1 | tee playwright-output.txt

      - name: Check for flaky tests
        id: check-flaky
        if: success()
        run: |
          # Playwright outputs "X flaky" in its summary when tests pass on retry
          if grep -qE "[0-9]+ flaky" platform/playwright-output.txt 2>/dev/null; then
            echo "âš ï¸ Flaky tests detected"
            echo "has_flaky_tests=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload Playwright report
        if: failure() || steps.check-flaky.outputs.has_flaky_tests == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          retention-days: 30

      - name: Show logs on failure or flaky tests
        if: failure() || steps.check-flaky.outputs.has_flaky_tests == 'true'
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200

          echo "=== WireMock Logs ==="
          kubectl logs -l app=e2e-tests-wiremock --tail=200

          echo "=== Keycloak Logs ==="
          kubectl logs -l app.kubernetes.io/name=keycloak --tail=200

          echo "=== Describe Archestra Platform Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=archestra-platform

          echo "=== Describe PostgreSQL Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=postgresql

  platform-docker-image-scanning:
    name: Platform Docker Image Scanning
    runs-on: ubuntu-latest
    # Reuse the pre-built image instead of building again
    # Skip for docs-only changes
    needs: [paths-filter, build-platform-image]
    if: |
      github.event_name == 'pull_request' &&
      inputs.should-skip-running-and-always-succeed != true &&
      needs.paths-filter.outputs.platform-code == 'true'
    permissions:
      contents: read
    steps:
      - name: Download Docker image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: platform-docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/platform-image.tar

      # Scan Docker image for CVEs using Docker Scout
      # https://github.com/docker/scout-action
      #
      # Fails the CI check if any critical or high severity CVEs are found.
      # Only checks for CVEs with available fixes (ignores unfixed vulnerabilities).
      #
      # NOTE: Skipped for fork PRs because GitHub doesn't expose repository secrets
      # to workflows triggered by fork PRs. Docker Scout requires Docker Hub auth.
      - name: Docker Scout CVE Check
        if: ${{ github.event.pull_request.head.repo.fork != true }}
        uses: docker/scout-action@f8c776824083494ab0d56b8105ba2ca85c86e4de # v1.18.2
        with:
          command: cves
          image: archestra/platform:ci-test
          dockerhub-user: ${{ secrets.DOCKER_USERNAME }}
          dockerhub-password: ${{ secrets.DOCKER_PASSWORD }}
          only-severities: critical,high
          only-fixed: true
          write-comment: false
          exit-code: true

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ./platform/helm/archestra
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v1.0.3
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1

  # Test that the MCP server base Docker image builds successfully
  # Only runs when relevant files are changed
  mcp-server-base-image-build:
    name: MCP Server Base Image Build
    needs: paths-filter
    if: ${{ needs.paths-filter.outputs.mcp-server-base-image == 'true' }}
    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation
    uses: ./.github/workflows/build-base-mcp-server-docker-image.yml
    with:
      push_to_gcr: false
      version: test
