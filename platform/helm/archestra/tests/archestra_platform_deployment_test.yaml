suite: test archestra platform -- Deployment/Service (split backend/frontend)
templates:
  - archestra-platform.yaml
tests:
  # =============================================================================
  # Backend Service Tests (documentIndex: 0)
  # =============================================================================
  - it: should create a backend Service with correct metadata
    documentIndex: 0
    asserts:
      - isKind:
          of: Service
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-backend$
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: backend

  - it: should expose backend port 9000 on backend service
    documentIndex: 0
    asserts:
      - contains:
          path: spec.ports
          content:
            name: backend
            port: 9000
            targetPort: backend
            protocol: TCP

  - it: should expose metrics port 9050 on backend service
    documentIndex: 0
    asserts:
      - contains:
          path: spec.ports
          content:
            name: metrics
            port: 9050
            targetPort: metrics
            protocol: TCP

  - it: should NOT expose frontend port 3000 on backend service
    documentIndex: 0
    asserts:
      - notContains:
          path: spec.ports
          content:
            name: frontend

  - it: backend service should select backend component
    documentIndex: 0
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: backend

  # =============================================================================
  # Frontend Service Tests (documentIndex: 1)
  # =============================================================================
  - it: should create a frontend Service with correct metadata
    documentIndex: 1
    asserts:
      - isKind:
          of: Service
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-frontend$
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: frontend

  - it: should expose frontend port 3000 on frontend service
    documentIndex: 1
    asserts:
      - contains:
          path: spec.ports
          content:
            name: frontend
            port: 3000
            targetPort: frontend
            protocol: TCP

  - it: should NOT expose backend ports on frontend service
    documentIndex: 1
    asserts:
      - notContains:
          path: spec.ports
          content:
            name: backend
      - notContains:
          path: spec.ports
          content:
            name: metrics

  - it: frontend service should select frontend component
    documentIndex: 1
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: frontend

  # =============================================================================
  # Backend Deployment Tests (documentIndex: 2)
  # =============================================================================
  - it: should create a backend Deployment with correct metadata
    documentIndex: 2
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-backend$
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: backend

  - it: should allow configuring backend replica count
    documentIndex: 2
    set:
      archestra.replicaCount: 4
    asserts:
      - equal:
          path: spec.replicas
          value: 4

  - it: backend should not have replicas field when HPA is enabled
    documentIndex: 2
    set:
      archestra.horizontalPodAutoscaler.enabled: true
    asserts:
      - isNull:
          path: spec.replicas

  - it: backend should have replicas field when HPA is disabled
    documentIndex: 2
    set:
      archestra.horizontalPodAutoscaler.enabled: false
      archestra.replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: backend should configure RollingUpdate deployment strategy with zero-downtime defaults
    documentIndex: 2
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0

  - it: backend should allow overriding deployment strategy
    documentIndex: 2
    set:
      archestra.deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: "25%"
          maxUnavailable: 1
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: "25%"
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 1

  - it: backend should configure container with correct image
    documentIndex: 2
    set:
      archestra.image: archestra/platform
      archestra.imageTag: test-version
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: archestra/platform:test-version

  - it: backend should set ARCHESTRA_RUN_MODE to backend
    documentIndex: 2
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_RUN_MODE
            value: "backend"

  - it: backend should expose backend and metrics ports
    documentIndex: 2
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: backend
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9000
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: metrics
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 9050

  - it: backend should set ARCHESTRA_DATABASE_URL to internal postgres when external_database_url is null
    documentIndex: 2
    set:
      postgresql.external_database_url: null
      postgresql.auth.username: testuser
      postgresql.auth.database: testdb
    asserts:
      # First env var should be ARCHESTRA_RUN_MODE
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: ARCHESTRA_RUN_MODE
      # Then PGPASSWORD from secret
      - equal:
          path: spec.template.spec.containers[0].env[1].name
          value: PGPASSWORD
      - equal:
          path: spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.key
          value: password
      # Then ARCHESTRA_DATABASE_URL
      - equal:
          path: spec.template.spec.containers[0].env[2].name
          value: ARCHESTRA_DATABASE_URL
      - matchRegex:
          path: spec.template.spec.containers[0].env[2].value
          pattern: ^postgresql://testuser:\$\(PGPASSWORD\)@.*-archestra-platform-postgresql:5432/testdb$

  - it: backend should set ARCHESTRA_DATABASE_URL to external postgres when external_database_url is provided
    documentIndex: 2
    set:
      postgresql.enabled: false
      postgresql.external_database_url: postgresql://external:pass@external-host:5432/externaldb
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_DATABASE_URL
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-archestra-platform-auth
                key: database-url

  - it: backend should have init container to wait for PostgreSQL
    documentIndex: 2
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-postgres
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:1.36

  - it: backend should have startup probe configured
    documentIndex: 2
    asserts:
      - exists:
          path: spec.template.spec.containers[0].startupProbe
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: backend

  - it: backend should have liveness probe configured
    documentIndex: 2
    asserts:
      - exists:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: backend

  - it: backend should have readiness probe configured
    documentIndex: 2
    asserts:
      - exists:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: backend

  - it: backend should have default memory resources configured
    documentIndex: 2
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "3Gi"

  - it: backend should add custom environment variables when archestra.env is set
    documentIndex: 2
    set:
      archestra.env:
        ARCHESTRA_API_BASE_URL: "https://api.example.com"
        CUSTOM_VAR: "custom-value"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_API_BASE_URL
            value: "https://api.example.com"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: "custom-value"

  # =============================================================================
  # Frontend Deployment Tests (documentIndex: 3)
  # =============================================================================
  - it: should create a frontend Deployment with correct metadata
    documentIndex: 3
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: -archestra-platform-frontend$
      - equal:
          path: spec.replicas
          value: 1
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: frontend

  - it: frontend should use Recreate strategy by default
    documentIndex: 3
    asserts:
      - equal:
          path: spec.strategy.type
          value: Recreate

  - it: frontend should allow configuring replica count
    documentIndex: 3
    set:
      archestra.frontend.replicaCount: 2
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: frontend should allow overriding deployment strategy
    documentIndex: 3
    set:
      archestra.frontend.deploymentStrategy:
        type: RollingUpdate
        rollingUpdate:
          maxSurge: 1
          maxUnavailable: 0
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0

  - it: frontend should set ARCHESTRA_RUN_MODE to frontend
    documentIndex: 3
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_RUN_MODE
            value: "frontend"

  - it: frontend should set ARCHESTRA_API_BASE_URL to point to backend service
    documentIndex: 3
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_API_BASE_URL
            value: "http://RELEASE-NAME-archestra-platform-backend:9000"

  - it: frontend should expose only frontend port
    documentIndex: 3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: frontend
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 3000

  - it: frontend should have init container to wait for backend
    documentIndex: 3
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: wait-for-backend
      - equal:
          path: spec.template.spec.initContainers[0].image
          value: busybox:1.36
      - matchRegex:
          path: spec.template.spec.initContainers[0].command[2]
          pattern: ".*-archestra-platform-backend.*9000.*"

  - it: frontend should have startup probe configured
    documentIndex: 3
    asserts:
      - exists:
          path: spec.template.spec.containers[0].startupProbe
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].startupProbe.httpGet.port
          value: frontend

  - it: frontend should have liveness probe configured
    documentIndex: 3
    asserts:
      - exists:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: frontend

  - it: frontend should have readiness probe configured
    documentIndex: 3
    asserts:
      - exists:
          path: spec.template.spec.containers[0].readinessProbe
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: frontend

  - it: frontend should have default memory resources configured
    documentIndex: 3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "512Mi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "1Gi"

  - it: frontend should allow overriding resources
    documentIndex: 3
    set:
      archestra.frontend.resources:
        requests:
          cpu: "250m"
          memory: "256Mi"
        limits:
          cpu: "1"
          memory: "2Gi"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "250m"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "256Mi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "1"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "2Gi"

  - it: frontend should configure container with correct image
    documentIndex: 3
    set:
      archestra.image: archestra/platform
      archestra.imageTag: test-version
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: archestra/platform:test-version

  - it: frontend should pass through custom env vars (excluding database vars)
    documentIndex: 3
    set:
      archestra.env:
        ARCHESTRA_API_EXTERNAL_BASE_URL: "https://api.example.com"
        CUSTOM_VAR: "custom-value"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_API_EXTERNAL_BASE_URL
            value: "https://api.example.com"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: CUSTOM_VAR
            value: "custom-value"

  # =============================================================================
  # Service Annotation Tests
  # =============================================================================
  - it: backend service should not have annotations when archestra.service.annotations is empty
    documentIndex: 0
    set:
      archestra.service.annotations: {}
    asserts:
      - isNull:
          path: metadata.annotations

  - it: backend service should apply annotations when provided
    documentIndex: 0
    set:
      archestra.service.annotations:
        cloud.google.com/backend-config: '{"ports": {"9000":"backend-config"}}'
    asserts:
      - equal:
          path: metadata.annotations["cloud.google.com/backend-config"]
          value: '{"ports": {"9000":"backend-config"}}'

  - it: frontend service should apply annotations when provided
    documentIndex: 1
    set:
      archestra.service.annotations:
        cloud.google.com/backend-config: '{"ports": {"3000":"frontend-config"}}'
    asserts:
      - equal:
          path: metadata.annotations["cloud.google.com/backend-config"]
          value: '{"ports": {"3000":"frontend-config"}}'

  # =============================================================================
  # Service Type Tests
  # =============================================================================
  - it: backend service should default to ClusterIP service type
    documentIndex: 0
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: frontend service should default to ClusterIP service type
    documentIndex: 1
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: backend service should support NodePort service type
    documentIndex: 0
    set:
      archestra.service.type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: frontend service should support NodePort service type
    documentIndex: 1
    set:
      archestra.service.type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  # =============================================================================
  # NodePort Configuration Tests
  # =============================================================================
  - it: backend service should configure backend nodePort when specified
    documentIndex: 0
    set:
      archestra.service.type: NodePort
      archestra.service.nodePorts:
        backend: 30000
        metrics: 30050
    asserts:
      - equal:
          path: spec.ports[0].nodePort
          value: 30000
      - equal:
          path: spec.ports[1].nodePort
          value: 30050

  - it: frontend service should configure frontend nodePort when specified
    documentIndex: 1
    set:
      archestra.service.type: NodePort
      archestra.service.nodePorts:
        frontend: 30300
    asserts:
      - equal:
          path: spec.ports[0].nodePort
          value: 30300

  # =============================================================================
  # Pod Annotations Tests
  # =============================================================================
  - it: backend deployment should not have pod annotations when archestra.podAnnotations is empty
    documentIndex: 2
    set:
      archestra.podAnnotations: {}
    asserts:
      - isNull:
          path: spec.template.metadata.annotations

  - it: backend deployment should apply pod annotations when provided
    documentIndex: 2
    set:
      archestra.podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9050"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/port"]
          value: "9050"

  - it: frontend deployment should apply pod annotations when provided
    documentIndex: 3
    set:
      archestra.podAnnotations:
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  # =============================================================================
  # Node Selector Tests
  # =============================================================================
  - it: backend deployment should not have nodeSelector when archestra.nodeSelector is empty
    documentIndex: 2
    set:
      archestra.nodeSelector: {}
    asserts:
      - isNull:
          path: spec.template.spec.nodeSelector

  - it: backend deployment should apply nodeSelector when provided
    documentIndex: 2
    set:
      archestra.nodeSelector:
        karpenter.sh/nodepool: general-purpose
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["karpenter.sh/nodepool"]
          value: general-purpose

  - it: frontend deployment should apply nodeSelector when provided
    documentIndex: 3
    set:
      archestra.nodeSelector:
        karpenter.sh/nodepool: general-purpose
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["karpenter.sh/nodepool"]
          value: general-purpose

  # =============================================================================
  # ServiceAccount Tests
  # =============================================================================
  - it: backend deployment should use default ServiceAccount name when serviceAccount.create is true
    documentIndex: 2
    set:
      archestra.orchestrator.kubernetes.serviceAccount.create: true
    asserts:
      - matchRegex:
          path: spec.template.spec.serviceAccountName
          pattern: -archestra-platform$

  - it: frontend deployment should use same ServiceAccount as backend
    documentIndex: 3
    set:
      archestra.orchestrator.kubernetes.serviceAccount.create: true
    asserts:
      - matchRegex:
          path: spec.template.spec.serviceAccountName
          pattern: -archestra-platform$

  # =============================================================================
  # Image Helper Tests
  # =============================================================================
  - it: backend should use image as-is when image already contains a tag
    documentIndex: 2
    set:
      archestra.image: archestra/platform:ci-test
      archestra.imageTag: "1.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: archestra/platform:ci-test

  - it: backend should append imageTag when registry has port but image has no tag
    documentIndex: 2
    set:
      archestra.image: registry.io:5000/archestra/platform
      archestra.imageTag: "1.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: registry.io:5000/archestra/platform:1.0.0

  - it: frontend should use same image as backend
    documentIndex: 3
    set:
      archestra.image: archestra/platform
      archestra.imageTag: "2.0.0"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: archestra/platform:2.0.0

  # =============================================================================
  # Sensitive Environment Variables Tests (Backend)
  # =============================================================================
  - it: backend should set ARCHESTRA_AUTH_SECRET from auto-generated secret by default
    documentIndex: 2
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_AUTH_SECRET
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-archestra-platform-auth
                key: auth-secret

  - it: backend should use secretKeyRef for ARCHESTRA_CHAT_ANTHROPIC_API_KEY
    documentIndex: 2
    set:
      archestra.env:
        ARCHESTRA_CHAT_ANTHROPIC_API_KEY: "sk-ant-api-key-123"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ARCHESTRA_CHAT_ANTHROPIC_API_KEY
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-archestra-platform-auth
                key: archestra-chat-anthropic-api-key

  # =============================================================================
  # Kubeconfig Volume Mount Tests (Backend only)
  # =============================================================================
  - it: backend should not mount kubeconfig volume when kubeconfig is disabled
    documentIndex: 2
    set:
      archestra.orchestrator.kubernetes.kubeconfig.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].volumeMounts
      - isNull:
          path: spec.template.spec.volumes

  - it: backend should mount kubeconfig volume when kubeconfig is enabled
    documentIndex: 2
    set:
      archestra.orchestrator.kubernetes.kubeconfig.enabled: true
      archestra.orchestrator.kubernetes.kubeconfig.secretName: "my-kubeconfig"
      archestra.orchestrator.kubernetes.kubeconfig.mountPath: "/etc/kubeconfig"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].name
          value: kubeconfig
      - equal:
          path: spec.template.spec.containers[0].volumeMounts[0].mountPath
          value: "/etc/kubeconfig"

  # =============================================================================
  # envFrom Tests (Backend)
  # =============================================================================
  - it: backend should not add envFrom section when envFrom is empty
    documentIndex: 2
    set:
      archestra.envFrom: []
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].envFrom

  - it: backend should add envFrom with single secretRef
    documentIndex: 2
    set:
      archestra.envFrom:
        - secretRef:
            name: my-secret
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - secretRef:
                name: my-secret
